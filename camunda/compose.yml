x-networks: &networks
  networks:
    - default
x-labels: &enable_traefik
  labels:
    - traefik.enable=true
x-restart: &restart
  restart: unless-stopped

services:
  # https://github.com/camunda/camunda-distributions/blob/main/docker-compose/versions/camunda-8.5/docker-compose.yaml
  zeebe:
    <<: [*networks, *restart]
    image: camunda/zeebe${ZEEBE_TAG:?}
    container_name: zeebe
    ports:
      # gRPC
      - ${ZEEBE_GRPC_PORT:-0.0.0.0:26500}:26500
      # monitoringApi
      # - 9600:9600
      # REST API
      - ${ZEEBE_REST_API_PORT:?}:8080
    environment:
      JAVA_TOOL_OPTIONS: "-Xms512m -Xmx512m"
      ZEEBE_BROKER_GATEWAY_SECURITY_AUTHENTICATION_MODE: ${ZEEBE_AUTHENTICATION_MODE:?}
      ZEEBE_BROKER_GATEWAY_MULTITENANCY_ENABLED: ${MULTI_TENANCY_ENABLED}
      ZEEBE_BROKER_EXPORTERS_ELASTICSEARCH_CLASSNAME: io.camunda.zeebe.exporter.ElasticsearchExporter
      ZEEBE_BROKER_EXPORTERS_ELASTICSEARCH_ARGS_URL: http://elasticsearch_cm:9200
      ZEEBE_BROKER_EXPORTERS_ELASTICSEARCH_ARGS_BULK_SIZE: 1000
      ZEEBE_BROKER_EXPORTERS_ELASTICSEARCH_ARGS_BULK_DELAY: 1
      SPRING_CONFIG_ADDITIONAL_LOCATION: /usr/local/zeebe/config/exporter.yml
      ZEEBE_BROKER_EXPORTERS_KAFKA_ARGS_PRODUCER_SERVERS: kafka:9092
    volumes:
      - ./zeebe:/usr/local/zeebe/data
      - ./exporter/exporter.yml:/usr/local/zeebe/config/exporter.yml
      - ./exporter/zeebe-kafka-exporter-3.1.1-jar-with-dependencies.jar:/usr/local/zeebe/lib/zeebe-kafka-exporter-3.1.1-jar-with-dependencies.jar
    depends_on:
      elasticsearch_cm:
        condition: service_healthy


  elasticsearch_cm:
    <<: [*networks, *restart]
    image: docker.elastic.co/elasticsearch/elasticsearch${STACK_VERSION:?}
    container_name: elasticsearch_cm
    ports:
      - ${ES_PORT:-0.0.0.0:9200}:9200
    environment:
      ES_JAVA_OPTS: "-Xms512m -Xmx512m"
      bootstrap.memory_lock: "true"
      discovery.type: "single-node"
      xpack.security.enabled: "false"
      xpack.security.enrollment.enabled: "false"
    volumes:
      - ./data:/usr/share/elasticsearch/data
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://elasticsearch_cm:9200/_cat/health | grep -q green" ]
      interval: 45s
      timeout: 5s
      retries: 60
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536

  kibana_cm:
    <<: [*networks, *enable_traefik, *restart]
    image: docker.elastic.co/kibana/kibana${STACK_VERSION:?}
    container_name: kibana_cm
    ports:
      - ${KIBANA_PORT:-0.0.0.0:5601}:5601
    environment:
      # https://www.elastic.co/guide/en/kibana/8.14/docker.html#environment-variable-config
      # https://github.com/elastic/elasticsearch/blob/8.14/docs/reference/setup/install/docker/docker-compose.yml
      SERVER_NAME: ${SERVERNAME:?}
      XPACK_SECURITY_ENABLED: "false"
      XPACK_MONITORING_ENABLED: "false"
      XPACK_APM_ENABLED: "false"
      XPACK_CANVAS_ENABLED: "false"
      XPACK_REPORTING_ENABLED: "false"
      XPACK_DASHBOARDS_ENABLED: "false"
      XPACK_ENCRYPTEDSAVEDOBJECTS_ENCRYPTIONKEY: ${KEY}
      SERVER_PUBLICBASEURL: "https://${SERVERNAME:?}"
      ELASTICSEARCH_HOSTS: "http://elasticsearch_cm:9200"
      TZ: ${TIMEZONE:-UTC}
    mem_limit: ${MEM_LIMIT:-1073741824}
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -s -I http://localhost:5601 | grep -q 'HTTP/1.1 302 Found'",
        ]
      interval: 10s
      timeout: 10s
      retries: 120
    depends_on:
      elasticsearch_cm:
        condition: service_healthy


networks:
  default:
    name: ${MYNET:?}
    external: true
